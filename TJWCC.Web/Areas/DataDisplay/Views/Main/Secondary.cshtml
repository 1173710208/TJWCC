
@{
    ViewBag.Title = "二级公司";
    Layout = "~/Views/Shared/_Main.cshtml";
}

<style>
</style>

<div class="container-fluid">
    <!-- @*头部*@ -->
    <div class="row " style="min-height:78px;vertical-align:middle;line-height:78px;">
        <div class="col-md-12 title-box">
            <div class='title-div title-left'></div>
            <span class="text-center" style="font-size:33px;color:white;padding:0 10px">三博水科技NB-IoT水表集抄平台</span>
            <div class='title-div title-right'></div>
            <div id="title-btn">
                <a class="pull-left" href="/DataDisplay/Main/Index"><span class="icon-GoBack"></span></a>        
                <a class="pull-right" href="/Login/OutLogin"><span class="icon-Exit"></span></a>
            </div>
        </div>
    </div>

    <!-- @*上半部分*@ -->
    <div class="row">
        <div class="col-md-3">
            <!---tab标签-->
            <div class="tabNav" style="font-size:12px;">
                <div class="col-md-4" style="padding-left:0px;padding-right:10px;"><div id="menu1" class="bg text-center tabNavMenu selected"><span></span></div></div>
                <div class="col-md-4" style="padding-right:10px;"><div id="menu2" class="bg text-center tabNavMenu"><span></span></div></div>
                <div class="col-md-4" style="padding-right:0px;"><div id="menu3" class="bg text-center tabNavMenu"><span></span></div></div>
            </div>
            <!--时间块-->
            <div class="box box-solid bg bg-one" id="box-time" style='height:200px'>
                <div class="box-body">
                    <div class="time">
                        <div>
                            <span id="time">-</span>
                        </div>
                        <div>
                            <span id="time-Hour1" class="icon-time">-</span>
                            <span id="time-Hour2" class="icon-time">-</span>
                            <span class="icon-time">:</span>
                            <span id="time-Minute1" class="icon-time">-</span>
                            <span id="time-Minute2" class="icon-time">-</span>
                            <span class="icon-time">:</span>
                            <span id="time-Second1" class="icon-time">-</span>
                            <span id="time-Second2" class="icon-time">-</span>
                        </div>
                    </div>
                    <div class="box box-solid  bg1" >
                        <div class="box-header" style='padding-bottom:0'>
                            <h3 class="box-title">NB-IoT水表总用水量：（吨）</h3>
                        </div>
                        <div class="box-body" style='padding:0'>
                            <div class="text-center">
                                <div class="icon-Water"></div> <span id="TotalWater">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 在线率 -->
            <div class="box box-solid bg bg-one" id="box-s-online">
                <div class="box-body">
                    <div class="title-bg"><span>在线率对比</span></div>
                    <div id="OnlineChart" style="height:215px;">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-solid bg" id="box-s-map">
                <div class="box-header " style="height:80px;">
                    <div class="col-md-3 center-block">
                        <div class="row center-block">
                            <div>
                                <img src='../../../Areas/DataDisplay/Content/img/ico-1.png'>
                                <span class="total-text">总表数(具)</span>
                            </div>
                            <div class="row center-block">
                                <span id="total-install" class="total-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="row  center-block">
                            <div>
                                <img src='../../../Areas/DataDisplay/Content/img/ico-2.png'>
                                <span class="total-text">在线(具)</span>
                            </div>
                            <div class="row center-block">
                                <span id="total-online" class="total-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3  center-block">
                        <div class="row  center-block">
                            <div>
                                <img src='../../../Areas/DataDisplay/Content/img/ico-3.png'>
                                <span class="total-text">离线(具)</span>
                            </div>
                            <div class="row center-block">
                                <span id="total-offline" class="total-value">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3  center-block">
                        <div class="row  center-block">
                            <div>
                                <img src='../../../Areas/DataDisplay/Content/img/ico-4.png'>
                                <span class="total-text">报警(条)</span>
                            </div>
                            <div class="row center-block">
                                <span id="total-alarm" class="total-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-body">
                    <div id="mapChart" style='width:100%;height:430px;'></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <!--日用水量-->
            <div class="box box-solid bg bg-one">
                <div class="box-body">
                    <div class="title-bg"><span>日用水量</span></div>
                    <div id='DayWater' style="height:185px;">
                    </div>
                </div>
            </div>
            <!--报警-->
            <div class="box box-solid bg bg-one" id="box-s-alarm" style="height:270px;">
                <div class="box-body">
                    <div class="title-bg"><span>报警对比</span></div>
                    <div id="AlarmChart" style="height:205px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- @*底部图表*@ -->
    <div class="row">
        <div class="col-md-12">
            <div class="box box-solid bg bg-two">
                <div class="box-body">
                    <div id="waterChart" style="min-height:230px;">
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script>
    resizeWaterChart();
    //水分析
    var waterChart = echarts.init(document.getElementById('waterChart'));
    //三级分公司报警
    var alarmChart = echarts.init(document.getElementById('AlarmChart'));
    //在线率对比
    var onlineChart = echarts.init(document.getElementById('OnlineChart'));
    //日用水量
    var dayWater = echarts.init(document.getElementById('DayWater'));
    //地图
    var mapChart = echarts.init(document.getElementById('mapChart'));

    let colorLine = ['rgba(137, 189, 27, 1)','rgba(0, 136, 212, 1)','rgba(219, 50, 51, 1)','rgba(112, 73, 240, 1)','rgba(250, 112, 77, 1)','rgba(1, 186, 188, 1)','rgba(208,87,14,1)']
    let colorBorder = ['rgba(137, 189, 27, 0.2)','rgba(0, 136, 212, 0.2)','rgba(219, 50, 51, 0.2)','rgba(112, 73, 240, 0.2)','rgba(250, 112, 77, 0.2)','rgba(1, 186, 188, 0.2)']
    let color0 = ['rgba(137, 189, 27, 0.3)','rgba(0, 136, 212, 0.3)','rgba(219, 50, 51, 0.3)','rgba(112, 73, 240, 0.3)','rgba(250, 112, 77, 0.3)','rgba(1, 186, 188, 0.3)']
    let color1 = ['rgba(137, 189, 27, 0)','rgba(0, 136, 212, 0)','rgba(219, 50, 51, 0)','rgba(112, 73, 240, 0)','rgba(250, 112, 77, 0)','rgba(1, 186, 188, 0)']

    //获取url地址参数函数分装
    function getUrlParam(key) {
        // 获取参数
        var url = window.location.search;
        // 正则筛选地址栏
        var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
        // 匹配目标参数
        var result = url.substr(1).match(reg);
        //返回参数值
        return result ? decodeURIComponent(result[2]) : null;
    }


    let corporateNameArr = [];//公司名称
    let geoJson;//地图选择地址
   //初始化二级页面
    $(function () {
        //获取公司名称(全局变量)
        $.ajax({
            url: "/SystemManage/Company/GetGridJson",
            type: "get",
            async: true,
            success: function (data) {
                let allCorporateArr = JSON.parse(data);
                allCorporateArr.forEach(function(item,index){
                    corporateNameArr.push(item.CNAME)
                    $("#menu"+(index+1)+">span").text(item.CNAME)
                });
                
                //根据参数选择二级公司
                @if (ViewData["id"] != null && !string.IsNullOrWhiteSpace(ViewData["id"].ToString())) {
                    <text>
                var id = '@Html.Raw(ViewData["id"].ToString())';
                $(".tabNav .tabNavMenu").removeClass("selected");
                $.each($(".tabNavMenu"), function (i, ele) {
                    if (this.id == id) {
                        $(this).addClass("selected");
                    }
                })
                    </text>
                }

                //获取二级公司相关信息
                GetSecondaryWater($(".selected").text()); 
            }
        });
    });



    ///获取二级公司相关数据
    function GetSecondaryWater(name) {
        //判断地图数据
        corporateNameArr.forEach(function(item,index){
            if(item == $(".selected").text()){
                if((index+1) == 1){
                    geoJson = second_map1
                }else if((index+1) == 2){
                    geoJson = second_map2
                }else if((index+1) == 3){
                    geoJson = second_map3  
                }
            }
        })
        //绘制地图
        {  
            //地图颜色
            let mapColor = [];
            echarts.registerMap('xiqing', geoJson);
            for(let i = 0;i<geoJson.features.length;i++){
                mapColor.push({
                    name: geoJson.features[i].properties.name,
                    itemStyle: {
                        normal: {
                            areaColor: colorLine[i],
                            opacity:.7,
                        },
                        emphasis: { //鼠标悬浮时样式
                            areaColor: colorLine[i],
                            opacity:.9,
                        }
                    },
                })
            }
            option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params, ticket, callback) {
                        console.log("aaaa")
                    }
                },
                geo:{
                    map: 'xiqing', 
                    type:'map',
                    label: {
                        normal: {
                            show: true,
                            color: "#3d3831",
                        },
                    },
                    roam: true,
                    regions:mapColor
                },
                series: [{
                    type: 'scatter',
                    coordinateSystem: 'geo',
                }]
            };
            mapChart.setOption(option,true);    
        }
        //总用水量额
        $.ajax({
            url: "/DataDisplay/Main/GetSecondaryTotalWater?CName=" + name,
            type: "get",
            async: false,
            success: function (data) {
                $("#TotalWater").text(data);
            }
        });

        //指定分公司总安装数量
        $.ajax({
            url: "/DataDisplay/Main/GetAllInstallAmountByCName?CName=" + name,
            type: "get",
            async: true,
            success: function (data) {
                $("#total-install").text(data);
            }
        });

        //指定分公司总在线数量
        $.ajax({
            url: "/DataDisplay/Main/GetOnlineAmountByCName?CName=" + name,
            type: "get",
            async: true,
            success: function (data) {
                $("#total-online").text(data);
            }
        });
        //指定分公司总离线数量
        $.ajax({
            url: "/DataDisplay/Main/GetOfflineAmountByCName?CName=" + name,
            type: "get",
            async: true,
            success: function (data) {
                $("#total-offline").text(data);
            }
        });

        //指定分公司总报警数量
        $.ajax({
            url: "/DataDisplay/Main/GetAllAlramByCName?CName=" + name,
            type: "get",
            async: true,
            success: function (data) {
                $("#total-alarm").text(data);
            }
        });

        //报警信息
        var alarmChartTitle = "";
        var alarmlegendData = [], alarmData = [];
        $.ajax({
            url: "/DataDisplay/Main/GetSubCompanyThreeLevelAlarm?CName=" + name,
            type: "get",
            async: false,
            success: function (data) {
                var JsonData = JSON.parse(data);
                alarmChartTitle = JsonData["Title"];//用水量图表标题
                //获取图例
                $.each(JsonData["Series"], function (i, ele) {
                    alarmlegendData.push(ele.Name);
                })
                //饼图数据
                alarmData = JSON.parse(JSON.stringify(JsonData["Series"]).toLowerCase());

            }
        });
        alarmChart.setOption({
            title: {
                textStyle: {
                    color: '#fff',
                    fontStyle: 'normal',
                    fontWeight: 'normal'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b}: {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                x: 'left',
                data: alarmlegendData,
                show: false,
                textStyle: {//图例文字的样式
                    color: '#fff',
                    fontSize: 16
                }
            },
            color: ["#f39d77", "#34db9a", "#2ca9e1", "#4466f4", "#eb6d71", "#f77d76", "#ed7791", "#c1e4e8", "#3dceed", "#4d6eb8", "#84a2d4", "#d7abea", "#093e99", "#f8b861", "#f9e58c"],
            series: [
                {
                    name: alarmChartTitle,
                    type: 'pie',
                    radius: ['30%', '60%'],

                    data: alarmData
                }
            ]
        });

       //根据二级公司获取所属三级公司的安装数量和在线数量
        $.ajax({
            url: "/DataDisplay/Main/GetInstallAndOnlineAmountByCname?cname=" + name,
            type: "get",
            async: true,
            success: function (data) {
                var jsonData = JSON.parse(data);
                $.each(jsonData, function (i, ele) {
                    //天津自来水
                    if ($(".selected").attr("id") == "menutj") {
                        $("#tjAreaMap area:eq(" + i + ")").attr({
                            Title: ele.BNAME + "\r\n安装数量：" + ele.INSTALLAMOUNT + "\r\n在线数量：" + ele.ONLINEAMOUNT
                        });
                        var AreaName = $("#tjAreaMap area:eq(" + i + ")").attr("data-Text");
                        $("#" + AreaName).html(ele.BNAME + "<br />安装数量：" + ele.INSTALLAMOUNT + "<br />在线数量：" + ele.ONLINEAMOUNT);
                    }
                    //威立雅自来水
                    else if ($(".selected").attr("id") == "menuwly") {
                        $("#wlyAreaMap area:eq(" + i + ")").attr({
                            Title: ele.BNAME + "\r\n安装数量：" + ele.INSTALLAMOUNT + "\r\n在线数量：" + ele.ONLINEAMOUNT
                        });
                        var AreaName = $("#wlyAreaMap area:eq(" + i + ")").attr("data-Text");
                        $("#" + AreaName).html(ele.BNAME + "<br />安装数量：" + ele.INSTALLAMOUNT + "<br />在线数量：" + ele.ONLINEAMOUNT);

                    }
                        //滨海自来水
                    else if ($(".selected").attr("id") == "menubh") {
                        $("#bhAreaMap area:eq(" + i + ")").attr({
                            Title: ele.BNAME + "\r\n安装数量：" + ele.INSTALLAMOUNT + "\r\n在线数量：" + ele.ONLINEAMOUNT
                        });
                        var AreaName = $("#bhAreaMap area:eq(" + i + ")").attr("data-Text");
                        $("#" + AreaName).html(ele.BNAME + "<br />安装数量：" + ele.INSTALLAMOUNT + "<br />在线数量：" + ele.ONLINEAMOUNT);

                    }
                })
            }
        });
        //在线率对比(暂时假数据)
        let onlineChartTitle = [];
        //数据
        let onlineChartData = [];
        //数据暂存
        let onlineData = [];
        $.ajax({
            url: "/DataDisplay/Main/GetInstallAndOnlineAmountByCname?cname=" + name,
            type: "get",
            async: false,
            success: function (data) {
                var JsonData = JSON.parse(data);
                $.each(JsonData, function (i, ele) {
                    onlineChartTitle.push(ele.BNAME);
                    onlineChartData.push(Math.ceil((ele.ONLINEAMOUNT/ele.INSTALLAMOUNT)*100)); //做了一个向上取整
                });
            }
        });
        for(let i = 0;i < onlineChartData.length;i++){
            onlineData.push({
                value:onlineChartData[i],
                itemStyle: {
                    normal: {
                        color: colorLine[i],
                        opacity: .6
                    }
                }
            })
        }
        onlineChart.setOption({
            tooltip: {
                formatter:function(params){
                    return params.marker + params.name+":"+params.value+'%'
                },
                textStyle: {
                    fontSize: 16,
                    color: '#fff',
                    fontFamily: 'Microsoft YaHei'
                },
            },
            angleAxis: {
                interval: 1,
                type: 'category',
                data: onlineChartTitle,
                z: 10,
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: "#00c7ff",
                        width: 1,
                        type: "solid"
                    },
                },
                axisLabel: {
                    interval: 0,
                    show: true,
                    color: "#00c7ff",
                    margin: 8,
                    fontSize: 12
                },
            },
            radiusAxis: {
                min: 0,
                max: 100,
                interval: 20,
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: "#00c7ff",
                        width: 1,
                        type: "solid"
                    },
                },
                axisLabel: {
                    formatter: '{value} %',
                    show: true,
                    padding: [0, 0, 5, 0],
                    color: "#00c7ff",
                    fontSize: 12
                },
                splitLine: {
                    lineStyle: {
                        color: "#0d346e",
                        width: 1,
                        type: "solid"
                    }
                },
            },
            polar: {},
            series: [{
                type: 'bar',
                data: onlineData,
                coordinateSystem: 'polar',
            }],
        })


        //日用水量
        let dayWaterTile = [];
        let dayWaterData = [];
        //暂存数据
        let dayData = [];
        $.ajax({
            url: "/DataDisplay/Main/GetBWaterByCname?cname=" + name,
            type: "get",
            async: false,
            success: function (data) {
                var JsonData = JSON.parse(data);
                $.each(JsonData["Series"], function (i, ele) {
                    dayWaterTile.push(ele.Name);
                    dayWaterData.push(ele.Data[0]);
                });
            }
        });
        //分区名
        for(let i = 0; i < dayWaterTile.length;i++){
            dayData.push({
                value: dayWaterData[i],
                itemStyle: {
                    color: colorLine[i]
                }
            })
        }
        dayWater.setOption({
            grid: {
                top: "12%",
                left: "1%",
                bottom: "1%",
                right: "1%",
                containLabel: true
            },
            tooltip: {
                trigger: 'item',
            },
            xAxis: [{
                type: "category",
                data: dayWaterTile,
                axisTick: {
                    alignWithLabel: true
                },
                axisLine: {
                    lineStyle: {
                        color: "#0d346e"
                    }
                },
                axisLabel: {
                    textStyle: {
                        color: '#59588D',
                        fontSize:12,
                    }
                }
            }],
            yAxis: [{
                type: "value",
                axisLabel: {
                    interval: 0,//强制文字产生间隔
                    formatter: '{value}吨',
                    textStyle: {
                        color: '#59588D',
                        fontSize:12,
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#0d346e'
                    }
                },
                //网格样式
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: ['#0d346e'],
                        width: 1,
                        type: 'solid'
                    }
                }
            }],
            series: [{
                type: 'pictorialBar',
                symbolSize: [20, 10],
                symbolOffset: [0, -5],
                symbolPosition: 'end',
                z: 12,
                label: {
                    normal: {
                        show: true,
                        position: "top",
                        formatter: "{c}吨"
                    }
                },
                data: dayData //柱顶圆
                },{ //柱低座圆
                    name: '',
                    type: 'pictorialBar',
                    symbolSize: [20, 10],
                    symbolOffset: [0, 5],
                    z: 12,
                    data: dayData
                },{ //数据柱
                    type: 'bar',
                    itemStyle: {
                        normal: {
                            opacity: .7
                        }
                    },
                    barWidth: "20",
                    data: dayData,
                }
            ]           
        })

        //根据二级公司名称获取所属三级公司的24小时用水量
        var waterChartTitle = "";
        var LegendSelected ={}; //图例控制显示
        var waterlegendData = [], SeriesData = [], HourWaterData = [];
        let trendSeries = []; //用水量走势数据重定义
        //用水趋势区域颜色
        $.ajax({
            url: "/DataDisplay/Main/GetBHourWaterByCname?cname=" + name,
                type: "get",
                async: false,
            success: function (data) {
                var JsonData = JSON.parse(data);
                waterChartTitle = JsonData["Title"];//用水量图表标题
                $.each(JsonData["Series"], function (i, ele) {
                    waterlegendData.push(ele.Name);
                    HourWaterData[i] = new Array();
                    $.each(ele.Data, function (j, wele) {
                        HourWaterData[i].push(wele);
                    });
                    var series = {
                        name: ele.Name,
                        type: 'line',
                        data: HourWaterData[i],
                        smooth: true,

                    }
                    SeriesData.push(series);
                });
            }
        });

        //图例控制(立即执行函数)第一次加载只显示前三个
        (function (){
            for(let i = 0;i<waterlegendData.length;i++){
                if(i>2){
                    var key = waterlegendData[i];
                    LegendSelected[key] = false;
                }
            }
        }());
        for(let i =  0;i < SeriesData.length;i++){
            trendSeries.push({
                name:SeriesData[i].name,
                type:'line',
                data:SeriesData[i].data,
                //smooth: true, //曲线
                symbol: 'circle',
                symbolSize: 5,
                //showSymbol: false, //数据点
                lineStyle: {
                    normal: {
                        width: 1
                    }
                },
                //区域颜色渐变
                /*areaStyle: {
                    normal: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: color0[i],
                        }, {
                            offset: 0.8,
                            color: color1[i],
                        }], false),
                        shadowColor: 'rgba(0, 0, 0, 0.1)',
                        shadowBlur: 10
                    }
                },*/
                itemStyle: {
                    normal: {
                        color: colorLine[i],
                        borderColor: colorBorder[i],
                        borderWidth: 12
                    }
                },
            })
        }
        waterChart.setOption({
            title: {
                text: waterChartTitle,
                textStyle: {
                    color: '#fff',
                    fontStyle: 'normal',
                    fontWeight: 'normal'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                    type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                }
            },
            legend: {
                data: waterlegendData,
                x: 'right',
                textStyle: {
                    color: '#fff',
                    fontSize: 16
                },
                selected:LegendSelected
            },
            grid: {
                left: '1%',
                right: '1%',
                bottom: '2%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24'],
                axisLabel: {
                    interval: 0,//强制文字产生间隔
                    textStyle: {
                        color: '#59588D',
                        fontSize:12,
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#0d346e'
                    }
                },
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    interval: 0,//强制文字产生间隔
                    formatter: '{value}吨',
                    textStyle: {
                        color: '#59588D',
                        fontSize:12,
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#0d346e'
                    }
                },
                //网格样式
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#0d346e',
                        width: 1,
                        type: 'solid'
                    }
                }
            },
            series: trendSeries
        },true);
    }
        

    window.onresize = function () {
        resizeWaterChart();
        alarmChart.resize();
        waterChart.resize();
        onlineChart.resize();
        dayWater.resize();
        mapChart.resize();
    }
    ///动态修改底部用水量图表高度
    function resizeWaterChart() {
        var waterChartH = $(window).height() - 650;
        $("#waterChart").height(waterChartH);
    }
</script>
