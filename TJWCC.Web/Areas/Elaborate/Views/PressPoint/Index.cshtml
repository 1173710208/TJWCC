
@{
    ViewBag.Title = "压力监测点优化布置";
    Layout = "~/Views/Shared/_Index.cshtml";
}

@* arcgis  *@
<link rel="stylesheet" type="text/css" href="@TJWCC.Code.OperatorProvider.Provider.GetCurrent().ArcGISAPI/dijit/themes/tundra/tundra.css" />
<link rel="stylesheet" type="text/css" href="@TJWCC.Code.OperatorProvider.Provider.GetCurrent().ArcGISAPI/esri/css/esri.css" />
<script src="@TJWCC.Code.OperatorProvider.Provider.GetCurrent().ArcGISAPI/init.js"></script>
<link href="~/Areas/DataDisplay/Content/css/bootstrap.css" rel="stylesheet" />
<link href="~/Areas/DataDisplay/Content/css/OptimalLayout.css" rel="stylesheet" />
<link href="~/Areas/DataDisplay/Content/css/unite.css" rel="stylesheet" />
<link href="~/Areas/DataDisplay/Content/css/map/indexMap.css" rel="stylesheet" />
<script src="~/Areas/DataDisplay/Content/js/map/map2.js"></script>
<script src="~/Content/js/HashTable.js"></script>
<script type="text/javascript">
    var ArcGISServer = "@TJWCC.Code.OperatorProvider.Provider.GetCurrent().ArcGISServer";
    var ArcGISAPI = "@TJWCC.Code.OperatorProvider.Provider.GetCurrent().ArcGISAPI/";
    var PressUnitConv = 100;//水压单位换算
    var PressUnit = "MPa";//水压单位
    var PressPlace = 3;//水压小数位
    var mPressUnit = "mH₂O";//模拟水压单位
    var mPressPlace = 2;//模拟水压小数位
    var ClUnit = "mg/L";//余氯单位
    var BgaUnit = "个/ml";//蓝绿藻单位
    var TurbUnit = "NTU";//浊度单位
    var FlowUnit = "m³/h";//流量单位
    var FlowVUnit = "m/s";//流速单位
    var PLengthUnit = "m";//管长单位
    var PDiameterUnit = "mm";//管径单位
    var JDepthUnit = "m";//埋深单位
    var JElevationUnit = "m";//高程单位
    var JAge = "小时";//水龄单位
</script>
<style>
    html {
        overflow-y: hidden !important;
    }

    body {
        overflow-y: hidden !important;
    }
    .active {
        background-color: #df7319;
    }
    .map_stss {
        right: 20px;
        bottom: 83px;
        height: 32px;
        width: 32px;
        border: 1px solid rgb(0,0,0);
        border-radius: 7px;
        z-index: 10;
        /*border-left: 0;*/
        position: absolute;
        text-align: center;
        line-height: 34px;
        font-size: 14px;
        float: left;
        color: black;
        background-color: white;
    }

        .map_stss:hover {
            cursor: pointer;
            background-color: rgb(224,236,255);
        }
</style>

<div class="main-container">
    <div class="middle">
        <div class="middle1">
            <div class="middle11">现有压力监测点信息</div>
            <div class="middle12">
                <div id="gridPanel" class="gridPanel" style="height:785px;">
                    <table id="gridList"></table>
                    <div id="gridPager"></div>
                </div>
            </div>
        </div>
        <div class="middle2">
            <div class="middle21">
                <div class="middle211">新增压力监测点数量</div>
                <input id="pressCount" class="middle212">
            </div>
            <div class="middle21">
                <button class="middle221" onclick="showPoint()">生成方案</button>
                <button class="middle222" onclick="reset()">重置</button>
            </div>
        </div>
    </div>

    <div class="right">
        <!-- 地图 -->
        <div id="map" class="right1" style="display:block;position: relative;">
            <div class="map_stss" id="fullExtent" onclick="fullExtentClick()">全图</div>
            <div class="right11">
                <button id="areaBut" class="right111" onclick="measutreArea(this)">选择区域</button>
            </div>
        </div>
        <!-- 地图 -->

        <div class="right2">
            <div class="right21">监测点优化布置方案</div>
            @*<button class="right22" onclick="CreatePressOrder()">下发明细</button>*@
            <button class="right23" onclick="btn_download()">导出</button>
        </div>

        <div class="right3">
            <div class="right31">
                <table class="right31_title">
                    <tr class="right311">
                        @*<th class="right3111"><input type="checkbox"></th>*@
                        <th class="right3112">编号</th>
                        <th class="right3112">名称</th>
                        <th class="right3112">地址</th>
                        <th class="right3112">管径</th>
                        <th class="right3112">所属公司</th>
                        <th class="right3112">高程（m）</th>
                    </tr>
                </table>
            </div>
            <div class="right32">
                <table id="newPoint" class="right32_data">
                    @*<tr class='right321'>
                        <td class='right3211'>
                            <input type='checkbox'>
                        </td>
                        <td class='right3212'>
                            1
                        </td>
                        <td class='right3212'>
                            压力计
                        </td>
                        <td class='right3212'>
                            玉门路
                        </td>
                        <td class='right3212'>
                            DN300
                        </td>
                        <td class='right3212'>
                            市南四营销
                        </td>
                        <td class='right3212'>
                            0.98
                        </td>
                    </tr>*@
                </table>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var isFirstRun = true;
    var FullExtent, graphicslayer, CLToolbartb, color1, font1, isCLToolbartbA = false;
    var tiled2, layerModelBaseMapMin, nodeMapLayer, geometryService, SmallQualitySymbol;
    var newPointList = "", junList = "", nodeCount = 0, caliber = [];
    var districtClass = new HashTable();
    $(function () {
        gridList();
    });
    function gridList() {
        var $gridList = $("#gridList");
        $gridList.dataGrid({
            url: "/Elaborate/PressPoint/GetPressPointList",
            height: 620,
            colModel: [
                { label: '名称', name: 'Meter_Name', width: 100, align: 'center' },
                { label: '地址', name: 'Physical_Address', width: 310, align: 'center' },
                { label: '管径', name: 'Measure_Grade', width: 60, align: 'center' },
                { label: '所属公司', name: 'Station_Unit', width: 100, align: 'center' },
                { label: '高程(m)', name: 'Physical_Elevation', width: 60, align: 'center' },
                { label: 'id', name: 'ElementID', hidden: true }
            ],
            sortname: 'Meter_Name asc',
            viewrecords: true
        });
    };
    require([
        "esri/basemaps",
        "esri/map",
        "esri/Color",
        "esri/toolbars/draw",
        "esri/dijit/Scalebar",
        "esri/dijit/HomeButton",
        "esri/dijit/OverviewMap",
        "esri/layers/GraphicsLayer",
        "esri/layers/ArcGISTiledMapServiceLayer",
        "esri/layers/ArcGISDynamicMapServiceLayer",
        "esri/tasks/GeometryService",
        "esri/tasks/query",
        "esri/tasks/QueryTask",
        "esri/tasks/IdentifyTask",
        "esri/tasks/IdentifyParameters",
        "esri/tasks/AreasAndLengthsParameters",
        "esri/tasks/LengthsParameters",
        "esri/symbols/Font",
        "esri/symbols/TextSymbol",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleFillSymbol",
        "esri/symbols/PictureMarkerSymbol",
        "dojo/query",
        "esri/InfoTemplate",
        "dojo/_base/array",
        "dojo/parser",
        "dojo/domReady!"
    ], function (
        esriBasemaps,
        Map,
        Color,
        Draw,
        Scalebar,
        HomeButton,
        OverviewMap,
        GraphicsLayer,
        ArcGISTiledMapServiceLayer,
        ArcGISDynamicMapServiceLayer,
        GeometryService,
        Query,
        QueryTask,
        IdentifyTask,
        IdentifyParameters,
        AreasAndLengthsParameters,
        LengthsParameters,
        Font,
        TextSymbol,
        SimpleLineSymbol,
        SimpleFillSymbol,
        PictureMarkerSymbol,
        dojoQuery,
        InfoTemplate,
        arrayUtils,
        parser) {
            //font1
            font1 = new Font("13px", Font.STYLE_NORMAL, Font.VARIANT_NORMAL, Font.WEIGHT_BOLDER);
            color1 = new Color([240, 138, 6]);
            color2 = new Color([51, 192, 94]);
            color3 = new Color([0, 105, 244]);
            parser.parse();
            var initExtent = new esri.geometry.Extent({ "xmin": 99192.63530892128, "ymin": 298825.92644339317, "xmax": 100742.03840772746, "ymax": 300589.11330310017, "spatialReference": map.spatialReference });
            esriBasemaps.delorme = {
                baseMapLayers: [
                    //中国矢量地图服务
                    {
                        url: ArcGISServer + "BaseMap/MapServer",
                        id: "底图",
                        opacity: 0.5
                    }
                ],
                //缩略图
                thumbnailUrl: "Imgs/shiliang.jpg",
                title: "矢量图"
            };
            //初始化地图
            map = new Map("map", {
                basemap: "delorme",
                logo: false,
                extent: initExtent,
                fadeOnZoom: true,
                showLabels: true,
                isDoubleClickZoom: false//关闭双击放大
            });

            //禁用键盘缩放平移
            map.disableKeyboardNavigation();
            //卫星底图
            //var toggle = new BasemapToggle({
            //    map: map,
            //    basemap: "satellite"
            //}, "BasemapToggle");
            //toggle.startup();
            //返回主视图
            var home = new HomeButton({
                map: map
            }, "HomeButton");
            home.startup();
            //定位
            //geoLocate = new LocateButton({
            //    map: map
            //}, "LocateButton");
            //geoLocate.startup();
            //鹰眼
            var overviewMapDijit = new OverviewMap({
                map: map,
                expandFactor: 100,
                attachTo: "bottom-left",
                visible: false
            });
            overviewMapDijit.startup();
            //比例尺
            var scalebar = new Scalebar({ map: map, attachTo: "bottom-left", scalebarUnit: "metric" });
            //显示坐标点
            //dojo.connect(map, "onLoad", function () {
            //    dojo.connect(map, "onMouseMove", showCoordinates);
            //    //dojo.connect(map, "onMouseDrag", showCoordinates);
            //    initCLToolbar();//初始化测量工具
            //});
            //基础元素搜索图层
            baseMapServerLayer = ArcGISServer + "ModelBaseMap/MapServer";
            //水泵搜索图层
            pumpMapLayer = ArcGISServer + "ModelBaseMap/MapServer/0";
            //水池搜索图层
            reservoirMapLayer = ArcGISServer + "ModelBaseMap/MapServer/1";
            //消火栓搜索图层
            hydrantMapLayer = ArcGISServer + "ModelBaseMap/MapServer/2";
            //阀门搜索图层
            valveMapLayer = ArcGISServer + "ModelBaseMap/MapServer/3";
            //节点搜索图层
            nodeMapLayer = ArcGISServer + "ModelBaseMap/MapServer/4";
            //管道搜索图层
            pipeMapLayer = ArcGISServer + "ModelBaseMap/MapServer/5";
            //水表搜索图层
            waterMeterMapLayer = ArcGISServer + "CheckMeterService/MapServer/0";
            //管道模拟数据搜索图层
            resultPipeMapLayer = ArcGISServer + "Result_Pipe_D/MapServer/0";
            //源水管网节点搜索图层
            sourceNodeMapLayer = ArcGISServer + "SourceWater_D/MapServer/2";

            //1.定义面的边界线符号
            outline = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255, 0, 0]), 3);
            //2.定义面符号
            //BigPolygonSymbol = new SimpleMarkerSymbol().setSize(12).setColor(new dojo.Color([0, 0, 255]));
            //RedBigPolygonSymbol = new SimpleMarkerSymbol().setSize(12).setColor(new dojo.Color([255, 0, 0]));
            //YellowBigPolygonSymbol = new SimpleMarkerSymbol().setSize(12).setColor(new dojo.Color([239, 242, 132]));
            //SmallPolygonSymbol = new SimpleMarkerSymbol().setSize(8).setColor(new dojo.Color([0, 0, 255]));
            BigPolygonSymbol = new PictureMarkerSymbol('Content/myImage/valve.png', 16, 16);
            RedBigPolygonSymbol = new PictureMarkerSymbol('Content/myImage/valves.png', 30, 34).setOffset(0, 17);
            ReBigPolygonSymbol = new PictureMarkerSymbol('Content/myImage/gif/阀.gif', 30, 34).setOffset(0, 17);
            RedGlowPolygonSymbol = new PictureMarkerSymbol('Content/myImage/gif/Red_glow.gif', 45, 45);
            WhiteBigPolygonSymbol = new PictureMarkerSymbol('Content/myImage/gif/Purple_glow.gif', 45, 45);
            YellowBigPolygonSymbol = new PictureMarkerSymbol('Content/myImage/traffic-cone.png', 34, 36).setOffset(0, 5);
            SmallPolygonSymbol = new PictureMarkerSymbol('/Areas/DataDisplay/Content/img/junction.png', 16, 16);
            SmallPressSymbol = new PictureMarkerSymbol('/Areas/DataDisplay/Content/img/press.png', 16, 16).setOffset(0, 8);
            SmallFlowSymbol = new PictureMarkerSymbol('/Areas/DataDisplay/Content/img/flow.png', 16, 16).setOffset(0, 8);
            SmallQualitySymbol = new PictureMarkerSymbol('/Areas/DataDisplay/Content/img/quality.png', 16, 16).setOffset(0, 8);
            WhiteSmallPolygonSymbol = new PictureMarkerSymbol('Content/myImage/gif/Blue_glow.gif', 45, 45);
            ReserviorPolygonSymbol = new PictureMarkerSymbol('Content/myImage/reservior.png', 32, 32);
            PumpPolygonSymbol = new PictureMarkerSymbol('Content/myImage/pump.png', 32, 32);
            HydrantPolygonSymbol = new PictureMarkerSymbol('Content/myImage/hydrant.png', 32, 32);
            pictureMarkerSymbol = new PictureMarkerSymbol('Content/myImage/gif/pipeBreak.gif', 35, 35).setOffset(0, 12);//爆管冒水动画图片
            BlackinfoPictureMSymbol = new PictureMarkerSymbol("Content/myImage/blackinfowin.png", 150, 48).setOffset(0, 24);
            BluePinPictureMSymbol = new PictureMarkerSymbol("Content/myImage/BluePin1LargeB.png", 64, 64).setOffset(0, 32);
            GreenPinPictureMSymbol = new PictureMarkerSymbol("Content/myImage/GreenPin1LargeB.png", 64, 64).setOffset(0, 32);
            BlueCPictureMSymbol = new PictureMarkerSymbol("Content/myImage/BluePin1LargeB.png", 32, 32).setOffset(0, 16);//聚合蓝色气泡标记
            GreenCPictureMSymbol = new PictureMarkerSymbol("Content/myImage/GreenPin1LargeB.png", 64, 64).setOffset(0, 16);//聚合绿色气泡标记
            RedCPictureMSymbol = new PictureMarkerSymbol("Content/myImage/RedPin1LargeB.png", 72, 72).setOffset(0, 16);//聚合红色气泡标记
            PinTextSymbol = new TextSymbol('', new Font("13px", Font.STYLE_NORMAL, Font.VARIANT_NORMAL, Font.WEIGHT_BOLDER), new dojo.Color([0, 0, 0])).setOffset(0, 25);//显示文字
            //overlay = new Echarts3Layer(map, echarts);
            //chartsContainer = overlay.getEchartsContainer();
            //myPipeFlowChart = overlay.initECharts(chartsContainer);
            //管网图
            var infoTemplatePoint = new InfoTemplate("元素信息", "${*}");
            geometryService = GeometryService("http://" + ArcGISServer.split('/')[2] + "/arcgis/rest/services/Utilities/Geometry/GeometryServer");//几何地图服务
            //将图例图层添加到
            layerModelBaseMap300 = new ArcGISDynamicMapServiceLayer(ArcGISServer + "ModelBaseMap300/MapServer", { id: "小于300管网图", visible: true });//小于300管网图
            map.addLayer(layerModelBaseMap300);
            tiled2 = new ArcGISTiledMapServiceLayer(ArcGISServer + "ModelBaseMap/MapServer", { id: "管网图", visible: true });//管网图层
            //tiled2 = new ArcGISDynamicMapServiceLayer(ArcGISServer + "ModelBaseMap/MapServer", { id: "管网图", visible: true });//管网图层
            map.addLayer(tiled2);
            SourceWater = new ArcGISDynamicMapServiceLayer(ArcGISServer + "SourceWater_D/MapServer", { id: "原水管网图", visible: true });//原水管网图
            //map.addLayer(SourceWater);
            Meter = new ArcGISDynamicMapServiceLayer(ArcGISServer + "Meter_D/MapServer", { id: "地表分布图", visible: true });//地表分布图
            map.addLayer(Meter);
            layerModelBaseMapMin = new ArcGISTiledMapServiceLayer(ArcGISServer + "ModelBaseMapMin/MapServer", { id: "细管网图", visible: false });//细管网图层
            map.addLayer(layerModelBaseMapMin);
            //map.addLayer(layerPressureChange);
            //layerGisPipe = new ArcGISTiledMapServiceLayer(ArcGISServer + "DetailPipeService/MapServer", { id: "管网详图", visible: false });//管网详图
            //map.addLayer(layerGisPipe);
            //计量分区搜索图层
            DBSArea2Laye = ArcGISServer + "MeasureArea_Info/MapServer/0";
            DBSArea1Laye = ArcGISServer + "MeasureArea_Info/MapServer/0";
            DBSArea0Laye = ArcGISServer + "MeasureArea_Info/MapServer/0";
            CLToolbartb = new Draw(map);
            CLToolbartb.on("draw-complete", doMeasure);
            //图层按钮单击事件
            setLayerVisibility = function (obj) {
                obj.children[0].checked = !(obj.children[0].checked);
                //用dojo.query获取class为listCss的元素数组
                var inputs = dojo.query(".listCBCss");
                var visible = [];
                //对checkbox数组进行变量把选中的id添加到visible
                for (var i = 0; i < inputs.length; i++) {
                    if (inputs[i].checked) {
                        visible.push(inputs[i].id);
                    }
                }
                //设置可视图层
                tiled2.setVisibleLayers(visible);
            };
            maplayersClick = function () {
                if (isMapLayers) {
                    recoverAll();
                    isMapLayers = false;
                } else {
                    recoverAll();
                    $("#maplayers").css("background", "#4b77be");//改变图层按钮颜色
                    var layersDisplay = document.getElementById("layersDisplay");
                    layersDisplay.innerHTML = "";
                    var layers = map.getLayersVisibleAtScale(map.getScale());
                    //layersDisplay
                    layersDisplay.style.display = "block";
                    arrayUtils.forEach(layers, function (layer) {
                        if (layer.id.indexOf("graphicsLayer") <= -1) {
                            layersDisplay.innerHTML += "<div class='layers-display-line' onclick='layersChange(this, 0, false, \"\")'>" + layer.id + "</div>";
                        }
                    });
                    layersDisplay.innerHTML += "<div class='layers-display-close' onclick='recoverAll()'>关闭</div>";
                    isMapLayers = true;
                }
            }
            //graphicslayer
            graphicslayer = new GraphicsLayer();//画图图层
            map.addLayer(graphicslayer);
            tbaGraphicslayer = new GraphicsLayer();//爆管画图图层
            map.addLayer(tbaGraphicslayer);
            map.on("update-start", showLoading);//add by huangxin 20180508地图加载时显示loading图标
            map.on("update-end", hideLoading);//add by huangxin 20180508地图加载完隐藏loading图标
            var identifyParams;//声明查询参数
            function showLoading() {//地图加载时显示loading图标
                $('#loadingImg').css('left', $("#map").width() / 2 - 42 + 'px');
                $('#loadingImg').css('top', $("#map").height() / 2 - 40 + 'px');
            }

            function hideLoading() {//地图加载完成后隐藏loading图标
                esri.hide(dojo.byId("loadingImg"));
                if (isFirstRun || FullExtent == null) {
                    isFirstRun = false;
                    homeExtent = map.extent;
                    FullExtent = tiled2.fullExtent;
                    //FullExtent = new esri.geometry.Extent({ "xmin": 12983527, "ymin": 4606694, "xmax": 13023121, "ymax": 4639295, "spatialReference": map.spatialReference });//地图显示的新区域;
                    //xmax: 13023121.408344664
                    //xmin: 12983527.027692996
                    //ymax: 4639295.278690283
                    //ymin: 4606694.8861267
                    //FullExtent.spatialReference = map.spatialReference;
                    $(".ovwButton.ovwController.ovwShow").click(function () {//鹰眼显示单击事件
                        var tmpdisplay = $(".ovwContainer").css("display");
                        if (tmpdisplay == "none")
                            $("#legendDivSoto").css("bottom", "70px");
                        else
                            $("#legendDivSoto").css("bottom", ($(".ovwContainer").height() + 3) + "px");
                    });
                    //updataTree();
                }
            }
            map.infoWindow.resize(245, 125);
        function doMeasure(geometry) {//量算
            geometry = geometry.geometry;
            dojo.disconnect(map.graphics, "onClick");
            //更加类型设置显示样式
            measuregeometry = geometry;
            CLToolbartb.deactivate();
            switch (geometry.type) {
                case "polyline":
                    var symbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([152, 106, 180]), 2);
                    break;
                case "polygon":
                    var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([152, 106, 180]), 2), new Color([152, 106, 180, 0.25]));
                    break;
            }
            //设置样式
            var graphic = new esri.Graphic(geometry, symbol);
            //清除上一次的画图内容
            map.graphics.clear();
            map.graphics.add(graphic);
            //进行投影转换，完成后调用projectComplete
            MeasureGeometry(geometry);
        }

        function MeasureGeometry(geometry) {//投影转换完成后调用方法
            if (geometry.type == "polyline") {//如果为线类型就进行lengths距离测算
                var lengthParams = new LengthsParameters();
                lengthParams.polylines = [geometry];
                lengthParams.lengthUnit = esri.tasks.GeometryService.UNIT_METER;
                lengthParams.geodesic = true;
                //lengthParams.polylines[0].spatialReference = new esri.SpatialReference(4509);
                lengthParams.polylines[0].spatialReference = map.spatialReference;
                geometryService.lengths(lengthParams);
                dojo.connect(geometryService, "onLengthsComplete", outputDistance);
            }
            else if (geometry.type == "polygon") {//如果为面类型需要先进行simplify操作在进行面积测算
                $.loading(true, '正在计算中...');
                var areasAndLengthParams = new AreasAndLengthsParameters();
                areasAndLengthParams.lengthUnit = esri.tasks.GeometryService.UNIT_METER;
                areasAndLengthParams.areaUnit = esri.tasks.GeometryService.UNIT_SQUARE_METERS;
                //this.outSR = new esri.SpatialReference({ wkid: 4509 });
                this.outSR = map.spatialReference;
                geometryService.project([geometry], this.outSR, function (geometry) {
                    geometryService.simplify(geometry, function (simplifiedGeometries) {
                        areasAndLengthParams.polygons = simplifiedGeometries;
                        //areasAndLengthParams.polygons[0].spatialReference = new esri.SpatialReference(4509);
                        areasAndLengthParams.polygons[0].spatialReference = map.spatialReference;
                        geometryService.areasAndLengths(areasAndLengthParams);
                    });
                });
                dojo.connect(geometryService, "onAreasAndLengthsComplete", outputAreaAndLength);
            }
        }
        function outputDistance(result) {//显示测量距离
            var CurX = measuregeometry.paths[0][measuregeometry.paths[0].length - 1][0];
            var CurY = measuregeometry.paths[0][measuregeometry.paths[0].length - 1][1];
            var CurPos = new esri.geometry.Point(CurX, CurY, map.spatialReference);
            map.infoWindow.setTitle("距离测量");
            map.infoWindow.setContent(" 测量长度：<strong>" + parseInt(String(result.lengths[0])) + "m</strong>");
            map.infoWindow.show(CurPos);
            map.infoWindow.resize(245, 58);
            $("#measutreLength").css("background", "");
            $("#measutreLength").css("color", "#000000");
            isCLToolbartbL = false;
        }

        function outputAreaAndLength(result) {//显示测量面积
            caliber = [];
            var caliberNum = [];
            var CurX = (measuregeometry.cache._extent.xmax + measuregeometry.cache._extent.xmin) / 2;
            var CurY = (measuregeometry.cache._extent.ymax + measuregeometry.cache._extent.ymin) / 2
            var CurPos = new esri.geometry.Point(CurX, CurY, map.spatialReference);
            var aalContent = "";
            var identifyParams = new IdentifyParameters();
            identifyParams.tolerance = 2; //设置容差
            identifyParams.geometry = measuregeometry;
            identifyParams.layerIds = [3, 4, 5]; //设置查找图层
            identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
            identifyParams.mapExtent = map.extent;
            identifyParams.returnGeometry = true;
            //实例化查询对象
            var identifyTask = new IdentifyTask(baseMapServerLayer);
            //地图点击查询结果处理
            identifyTask.execute(identifyParams, function (queryResult) {
                var valveCount = 0;
                nodeCount = 0;
                var nodeDem = 0;
                var pipeCount = 0;
                var pipeLen = 0;
                if (queryResult.length == 0) {
                    if (isCLToolbartbA)
                        $.loading();
                    aalContent = "<div class=\"display-div\"><div>面积：" + parseInt(String(result.areas[0])) + "㎡ </div><div>周长：" + parseInt(String(result.lengths[0])) + "m</div><div>需水量：" + nodeDem.toFixed(2) + "m³/h</div><div>阀门：" + valveCount + "个</div><div>节点：" + nodeCount + "个</div><div>管道：" + pipeCount + "条</div><div>管道长度：" + pipeLen.toFixed(2) + "m</div></div>";
                    map.infoWindow.setTitle("区域信息");
                    map.infoWindow.setContent(aalContent);
                    map.infoWindow.show(CurPos);
                    map.infoWindow.resize(195, 200);
                    $("#measutreArea").css("background", "");
                    $("#measutreArea").css("color", "#000000");
                    isCLToolbartbA = false;
                    return;
                }
                for (var i = 0; i < queryResult.length; i++) {
                    if (queryResult[i].layerId == 3) {
                        valveCount = valveCount + 1;
                    } else if (queryResult[i].layerId == 4) {//节点
                        //console.log(queryResult[i])
                        var caliberJson = {
                            ElementId: '',
                            Address: '',
                            Depth: '',
                            GISID: '',
                            Elevation: '',
                            District: '',
                            attr: '',
                        }
                        caliberJson.ElementId = queryResult[i].feature.attributes.ElementId;
                        caliberJson.Address = queryResult[i].feature.attributes.Physical_Address;
                        caliberJson.Depth = queryResult[i].feature.attributes.Physical_Depth;
                        caliberJson.GISID = queryResult[i].feature.attributes.GISID;
                        caliberJson.Elevation = queryResult[i].feature.attributes.Physical_Elevation;
                        caliberJson.District = districtClass.getValue(queryResult[i].feature.attributes.Physical_DistrictID);
                        caliberJson.attr = queryResult[i].feature.attributes;
                        //console.log(caliberJson)
                        caliber.push(caliberJson)
                        if (caliberNum.indexOf(queryResult[i].feature.attributes.Physical_Diameter) == -1) {
                            caliberNum.push(queryResult[i].feature.attributes.Physical_Diameter)
                            //    let arr = [];
                            //    arr.push(queryResult[i].feature.attributes.ElementId);
                            //    arr.push(queryResult[i].feature.attributes.Physical_Address);
                            //    arr.push(queryResult[i].feature.attributes.Physical_Status);
                            //    arr.push(queryResult[i].feature.attributes.GISID);
                            //    arr.push(queryResult[i].feature.attributes.Physical_Diameter)
                            //    caliber.push(arr)
                        }
                        if (nodeCount == 0) junList = queryResult[i].feature.attributes.ElementId + '';
                        else junList += ',' + queryResult[i].feature.attributes.ElementId;
                        nodeCount = nodeCount + 1;
                        nodeDem += Number(queryResult[i].feature.attributes.Physical_BaseDemand);
                    } else {
                        pipeCount = pipeCount + 1;
                        pipeLen += Number(queryResult[i].feature.attributes.Physical_Length);
                    }

                    if (i == queryResult.length - 1) {
                        let koujingClass = [];
                        let kongjingStr = '';

                        //console.log(caliberNum)
                        for (let i = 0; i < caliberNum.length; i++) {

                            let arr = [];
                            arr = caliber.filter(item => item.Diameter == caliberNum[i])
                            //console.log(arr)
                            koujingClass.push(arr.length)
                            //console.log(koujingClass)
                            //kongjingStr += "<div><input type='checkbox' id='" + caliberNum[i] + "' onclick='kongjinClick(this)'></input><input  id='check" + caliberNum[i] + "' style='display:none' value='" + JSON.stringify(arr) + "'></input>" + caliberNum[i] + "mm:" + koujingClass[i] + "个</div>"
                        }

                        //aalContent = "<div class=\"display-div\"><div>面积：" + parseInt(String(result.areas[0])) + "㎡ </div><div>周长：" + parseInt(String(result.lengths[0])) + "m</div><div>基本需水量：" + nodeDem.toFixed(2) + "m³/h</div><div>阀门：" + valveCount + "个</div><div>节点：" + nodeCount + "个</div><div>管道：" + pipeCount + "条</div><div>管道长度：" + pipeLen.toFixed(2) + "m</div></div>";
                        aalContent = "<div>阀门：" + valveCount + "个</div><div>节点：" + nodeCount + "个</div><div>管道：" + pipeCount + "条</div><div>管道长度：" + pipeLen.toFixed(2) + "m</div></div>";
                    }
                }
                //创建查询对象，注意：服务的后面有一个编号，代表对那一个图层进行查询
                var queryTask = new QueryTask(pipeMapLayer);
                //创建查询参数对象
                var query = new Query();
                query.where = "OBJECTID=1";
                //服务器给我们返回的字段信息，*代表返回所有字段
                query.outFields = ["OBJECTID"];
                //空间参考信息
                query.outSpatialReference = map.spatialReference;
                //查询的标准，此处代表和geometry相交的图形都要返回
                query.spatialRelationship = dojoQuery.SPATIAL_REL_INTERSECTS;
                //是否返回几何信息
                query.returnGeometry = false;
                //执行空间查询
                queryTask.execute(query, function (qResult) {
                    map.infoWindow.setTitle("区域信息");
                    map.infoWindow.setContent(aalContent);
                    map.infoWindow.show(CurPos);
                    map.infoWindow.resize(195, 200);
                    //$("#measutreArea").css("background", "");
                    //$("#measutreArea").css("color", "#000000");
                    if (isCLToolbartbA) {
                        $.loading();
                        //$("#areaBut").removeClass('active');
                        //isCLToolbartbA = false;
                    }
                });
            });
            //alert("面积：" + dojo.number.format(result.areas[0]) + "平方米" + " 长度：" + dojo.number.format(result.lengths[0]) + "米");
            }
        });
    function measutreArea(th) {
        $(".xiaoId").removeClass('active');
        $("#companyDatas").css("display", "none")
        flage = false
        if (!isCLToolbartbA) {
            graphicslayer.clear();
            isCLToolbartbA = true;
            CLToolbartb.activate(esri.toolbars.Draw.POLYGON);
            th.classList.add('active');
            isMapQuery = false;//是否图上查询标识
            $('#map').mousemove(function (e) {
                $('#followMouseInfo').hide();
            });
        } else {
            if (map.infoWindow.isShowing) map.infoWindow.hide();
            //画图图层
            graphicslayer.clear();
            th.classList.remove('active');
            CLToolbartb.deactivate();//取消绘画
            isCLToolbartbA = false;
        }
    }
    function showPoint() {//显示监测点
        graphicslayer.clear();
        //全图
        map.setExtent(tiled2.fullExtent, false);
        var jsonData = $("#gridList").jqGrid('getRowData');
        var query = new esri.tasks.Query();
        //数据读取
        for (var i = 0; i < jsonData.length; i++) {
            var queryTask = new esri.tasks.QueryTask(nodeMapLayer);
            query.where = "ElementId = " + jsonData[i].ElementID;
            query.outSpatialReference = map.spatialReference;
            query.returnGeometry = true;
            query.outFields = ["*"];
            queryTask.execute(query, function (featureSet) {
                if (featureSet.features.length == 0) {
                    $.modalMsg("未找到该元素！", "warning");
                    return;
                }
                var centerPoint = featureSet.features[0].geometry;
                let name = featureSet.features[0].attributes.Label.replace("yali-", "");
                //开始画，画成能够在页面上显示数字的形式。
                var point = new esri.geometry.Point(centerPoint.x, centerPoint.y, map.spatialReference);
                // 定义自变量
                let smsLength = (name.length * 14) + 5;//背景图片宽
                let smsLevel = smsLength * 50 / 180;    //图片水平偏移
                let textLevel = smsLength * 49 / 180;       //文字水平偏移
                var textSymbol1 = new esri.symbol.TextSymbol(name, font1, color1).setOffset(textLevel, 15.5556);
                var sms = new esri.symbol.PictureMarkerSymbol("/Areas/DataDisplay/Content/img/timg_blue.png", smsLength, 32).setOffset(smsLevel, 15);
                var graphic = new esri.Graphic(point, SmallQualitySymbol);
                var graphic1 = new esri.Graphic(point, textSymbol1);
                var graphic3 = new esri.Graphic(point, sms);
                //graphicslayer.add(graphic3);
                //graphicslayer.add(graphic1);
                graphicslayer.add(graphic);
            });
        }
        showNewPoint();
    }
    function showNewPoint() {//显示监测点
        //graphicslayer.clear();
        let areais = null;
        //全图
        map.setExtent(tiled2.fullExtent, false);
        let pCount = parseInt($("#pressCount").val());
        console.log(pCount);
        if (isNaN(pCount) || pCount < 1) {
            $.modalAlert("系统提示", "请输入大于0的整数！", "error");
            return;
        }
        if (isCLToolbartbA) {
            areais = 0;
            if (junList.length == 0) $.modalAlert("系统提示", "请在地图管网范围内选择区域！", "error");
            if (nodeCount <= pCount) {
                $.modalAlert("系统提示", "区域内节点数少于要生成的监测点个数！", "error");
                return;
            }
        }
        $.loading(true, '计算中...');
        $.ajax({
            type: "POST",
            url: "/Elaborate/PressPoint/CreateNewPressPoint",
            data: {
                isArea:areais,
                pCount: pCount,
                areaids: junList,
            },
            success: function (adata) {
                adata = adata.split(",");
                console.log(adata)
                let newPoint = document.getElementById("newPoint");
                newPoint.innerHTML = "";
                //var jsonData = JSON.parse(rowData);
                var query = new esri.tasks.Query();
                let index = 1;
                newPointList = "";
                //数据读取
                for (var i = 0; i < adata.length; i++) {
                    var queryTask = new esri.tasks.QueryTask(nodeMapLayer);
                    query.where = "ElementId = " + adata[i];
                    query.outSpatialReference = map.spatialReference;
                    query.returnGeometry = true;
                    query.outFields = ["*"];
                    queryTask.execute(query, function (featureSet) {
                        if (featureSet.features.length == 0) {
                            $.modalMsg("未找到该元素！", "warning");
                            return;
                        }
                        var centerPoint = featureSet.features[0].geometry;
                        let name = featureSet.features[0].attributes.Label;
                        let pointdata = featureSet.features[0].attributes;
                        newPoint.innerHTML += "<tr class='right321'><td class='right3212'>" + index + "</td><td class='right3212'>" + pointdata.Label +
                            "</td><td class='right3212'>" + pointdata.Physical_Address + "</td><td class='right3212'>DN200</td><td class='right3212'>" +
                            districtClass.getValue(pointdata.Physical_DistrictID) + "</td><td class='right3212'>" + pointdata.Physical_Elevation + "</td></tr>";
                        index = index + 1;
                        newPointList = newPointList + pointdata.ElementId + ",";
                        //开始画，画成能够在页面上显示数字的形式。
                        var point = new esri.geometry.Point(centerPoint.x, centerPoint.y, map.spatialReference);
                        // 定义自变量
                        let smsLength = (name.length * 14) + 5;//背景图片宽
                        let smsLevel = smsLength * 50 / 180;    //图片水平偏移
                        let textLevel = smsLength * 49 / 180;       //文字水平偏移
                        var textSymbol1 = new esri.symbol.TextSymbol(name, font1, color2).setOffset(textLevel, 15.5556);
                        var sms = new esri.symbol.PictureMarkerSymbol("/Areas/DataDisplay/Content/img/timg_orange.png", smsLength, 32).setOffset(smsLevel, 15);
                        var graphic = new esri.Graphic(point, SmallFlowSymbol);
                        var graphic1 = new esri.Graphic(point, textSymbol1);
                        var graphic3 = new esri.Graphic(point, sms);
                        graphicslayer.add(graphic3);
                        graphicslayer.add(graphic1);
                        graphicslayer.add(graphic);
                    });
                    if (i == adata.length - 1) $.loading();
                }
            }
        });
    }
    function CreatePressOrder() {
        $.ajax({
            url: '/Elaborate/PressPoint/CreatePressOrder?ids=' + newPointList.substring(0, newPointList.length - 1),
            type: 'post',
            success: function (data, response, status) {
                $.modalMsg("下发成功！", "success");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.modalMsg('无数据或数据解析错误！', 'warning');
                //TODO
            }
        });
    }
    function btn_download() {
        $.loading(true);
        $.ajax({
            url: "/Elaborate/PressPoint/GetDownloadJson?ids=" + newPointList.substring(0, newPointList.length - 1),
            success: function (adata) {
                let link = document.createElement('a');
                link.href = adata;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                $.loading();
                $.modalMsg("导出Excel成功！", "success");
            }
        })
    }
    function reset() {
        graphicslayer.clear();
        $("#pressCount").val("");
        document.getElementById("newPoint").innerHTML = "";
    }
    window.onresize = function () {
        var mainH = $(window).height() - 10;
        var mainW = $(window).width();
        $(".main-container").height(mainH);
        $(".main-container").width(mainW);
        //$("#map").height(mainH - 50);
        //$("#map").width(mainW - 440);
    }
    window.onload = function () {
        var mainH = $(window).height() - 10;
        var mainW = $(window).width();
        $(".main-container").height(mainH);
        $(".main-container").width(mainW);
        //$("#map").height(mainH - 50);
        //$("#map").width(mainW - 440);
        let gradeNum = 3;
        $.ajax({
            url: '/Elaborate/ValueCheck/GetDMAList',
            type: 'post',
            success: function (data, response, status) {
                if (data.length > 0) {
                    var dist = data[1]; //营销公司
                    if (gradeNum > 2) var dma = data[2];
                    if (gradeNum > 3) var dmaa = data[3];
                    for (var i = 0; i < dist.length; i++) {
                        var tmp1 = dist[i];
                        districtClass.add(tmp1[0], tmp1[1]);
                    }
                } else {
                    //$.messager.alert('提示', '无数据！', 'warning');
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.modalMsg('无数据或数据解析错误！', 'warning');
                //TODO
            }
        });
    }
</script>
